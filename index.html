<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SmartPay Checkout Demo</title>
    <style>
      :root {
        --bg: #ffffff;
        --text: #0f172a;
        --muted: #6b7280;
        --line: #e5e7eb;
        --surface: #f8fafc;
        --accent: #2563eb;
        --radius: 12px;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        min-height: 100%;
      }

      body {
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        color: var(--text);
        background: var(--bg);
      }

      .app {
        min-height: 100vh;
        display: grid;
        place-items: start center;
        padding: clamp(1rem, 3vw, 2rem);
      }

      .panel {
        width: min(520px, 100%);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        padding: 1.25rem;
        background: #fff;
        display: grid;
        gap: 1.1rem;
      }

      .header {
        border-bottom: 1px solid var(--line);
        padding-bottom: 1rem;
        display: grid;
        gap: 0.35rem;
      }

      h1 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 650;
      }

      h2 {
        margin: 0;
        font-size: 1rem;
      }

      .muted {
        color: var(--muted);
        margin: 0;
      }

      .section {
        display: grid;
        gap: 0.8rem;
      }

      .row {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        align-items: center;
      }

      .row .label {
        color: var(--muted);
        font-size: 0.9rem;
      }

      .price-chip {
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 0.18rem 0.6rem;
        font-size: 0.86rem;
        color: var(--muted);
      }

      .wallet-block {
        border: 1px solid var(--line);
        border-radius: var(--radius);
        padding: 0.6rem 0.75rem;
        background: var(--surface);
      }

      .wallet-block .row {
        margin: 0;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
      }

      .copy-btn,
      .btn {
        border: 1px solid var(--line);
        border-radius: var(--radius);
        padding: 0.45rem 0.7rem;
        font: inherit;
        cursor: pointer;
        background: #fff;
        color: var(--text);
      }

      .copy-btn:hover,
      .btn:hover {
        border-color: #cbd5e1;
      }

      .metrics {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 0.7rem;
      }

      .metric {
        border: 1px solid var(--line);
        border-radius: var(--radius);
        background: var(--surface);
        padding: 0.75rem;
      }

      .metric .label {
        color: var(--muted);
        font-size: 0.84rem;
      }

      .metric .value {
        font-size: 1.08rem;
        font-weight: 600;
      }

      .routes {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 0.6rem;
      }

      .route {
        text-align: left;
        border: 1px solid var(--line);
        border-radius: var(--radius);
        background: #fff;
        padding: 0.7rem;
        cursor: pointer;
      }

      .route.selected {
        border-color: var(--accent);
      }

      .route-title {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 600;
      }

      .route-meta {
        margin: 0.3rem 0 0;
        color: var(--muted);
        font-size: 0.86rem;
      }

      .summary {
        min-height: 2rem;
        border: 1px solid var(--line);
        border-radius: var(--radius);
        background: var(--surface);
        padding: 0.6rem 0.75rem;
        font-size: 0.9rem;
      }

      .status {
        min-height: 1.25rem;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .progress {
        height: 6px;
        border-radius: 999px;
        border: 1px solid var(--line);
        overflow: hidden;
        background: #fff;
      }

      .progress-fill {
        height: 100%;
        width: 0;
        background: var(--accent);
        transition: width 260ms ease;
      }

      .actions {
        display: flex;
        gap: 0.6rem;
      }

      .btn {
        flex: 1;
        text-align: center;
        font-weight: 600;
      }

      .btn.primary {
        border-color: var(--accent);
        color: #fff;
        background: var(--accent);
      }

      .btn.ghost {
        background: #fff;
      }

      .result {
        min-height: 2.3rem;
        border: 1px solid var(--line);
        border-radius: var(--radius);
        padding: 0.7rem 0.75rem;
        color: var(--muted);
        font-size: 0.9rem;
        background: #fff;
      }

      .result.success {
        color: var(--text);
      }

      .result.error {
        color: var(--muted);
      }

      @media (max-width: 580px) {
        .metrics,
        .routes,
        .actions {
          grid-template-columns: 1fr;
        }

        .actions {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <main class="app">
      <section class="panel" aria-label="SmartPay checkout demo">
        <header class="header">
          <h1>SmartPay Checkout</h1>
          <p class="muted">Pick a route, pay, and confirm.</p>
        </header>

        <section class="section">
          <div class="row">
            <div>
              <h2>Product</h2>
              <p class="muted">Premium access</p>
            </div>
            <span class="price-chip">$29.50</span>
          </div>

          <div class="row">
            <span class="label">Merchant</span>
            <strong>HOT Starter Merch</strong>
          </div>

          <div class="wallet-block">
            <div class="row">
              <span class="label">Wallet</span>
              <span class="pill">
                <span id="walletAddress">-</span>
                <button class="copy-btn" id="copyWallet" type="button">Copy</button>
              </span>
            </div>
          </div>
        </section>

        <section class="section">
          <div class="metrics">
            <div class="metric">
              <div class="label">You pay</div>
              <div class="value" id="youPay">$0.00</div>
            </div>
            <div class="metric">
              <div class="label">Network fee</div>
              <div class="value" id="networkFee">$0.00</div>
            </div>
            <div class="metric">
              <div class="label">Total</div>
              <div class="value" id="totalAmount">$0.00</div>
            </div>
          </div>
        </section>

        <section class="section">
          <p class="muted">Route strategy</p>
          <div class="routes" id="strategyGrid">
            <button class="route" data-strategy="fastest" type="button">
              <p class="route-title">Fastest</p>
              <p class="route-meta" id="fastestMeta">Loading</p>
            </button>
            <button class="route" data-strategy="cheapest" type="button">
              <p class="route-title">Cheapest</p>
              <p class="route-meta" id="cheapestMeta">Loading</p>
            </button>
            <button class="route" data-strategy="balanced" type="button">
              <p class="route-title">Balanced</p>
              <p class="route-meta" id="balancedMeta">Loading</p>
            </button>
          </div>
        </section>

        <section class="section">
          <div class="summary" id="routeSummary">Fetching route details…</div>
          <div class="progress"><div class="progress-fill" id="progressBar"></div></div>
          <div class="status" id="statusText">Ready</div>
        </section>

        <section class="section">
          <div class="actions">
            <button class="btn primary" id="payBtn" type="button">Pay $29.50</button>
            <button class="btn ghost" id="refreshBtn" type="button">Refresh routes</button>
          </div>
          <div class="result" id="resultPanel">
            <p id="resultText" class="muted">No payment yet.</p>
          </div>
        </section>
      </section>
    </main>

    <script type="module">
      import { smartPaySDK, createDemoWallet } from './smartpay/index.js';
      import { money, shortAddress } from './smartpay/core.js';

      const checkout = {
        id: 'demo-product-01',
        name: 'Smart Demo Product',
        priceMode: 'fixed',
        fixedAmount: 29.5,
        settlementAsset: 'USDC',
        acceptedPaymentMethods: ['ETH', 'USDC', 'USDT'],
      };

      const wallet = createDemoWallet({
        address: '0xDeMoWa11eT000000000000000000000000001',
        chainId: 1,
      });

      const networks = {
        ethereum: {
          label: 'Ethereum',
          gasBaseUsd: 4.8,
          latencyMinutes: 2.8,
          explorer: 'https://etherscan.io/tx/',
          rpcChainId: 1,
        },
      };

      const state = {
        quotes: null,
        route: null,
        strategy: 'fastest',
      };

      const $ = (id) => document.getElementById(id);
      const refs = {
        walletAddress: $('walletAddress'),
        copyWallet: $('copyWallet'),
        youPay: $('youPay'),
        networkFee: $('networkFee'),
        totalAmount: $('totalAmount'),
        routeSummary: $('routeSummary'),
        progressBar: $('progressBar'),
        statusText: $('statusText'),
        payBtn: $('payBtn'),
        refreshBtn: $('refreshBtn'),
        resultText: $('resultText'),
        resultPanel: $('resultPanel'),
      };

      const strategyCards = {
        fastest: document.querySelector('[data-strategy="fastest"]'),
        cheapest: document.querySelector('[data-strategy="cheapest"]'),
        balanced: document.querySelector('[data-strategy="balanced"]'),
      };

      const strategyMeta = {
        fastest: $('fastestMeta'),
        cheapest: $('cheapestMeta'),
        balanced: $('balancedMeta'),
      };

      const format = (value) => money(value || 0);

      function setProgress(value) {
        refs.progressBar.style.width = `${value}%`;
      }

      function setStatus(text) {
        refs.statusText.textContent = text;
      }

      function setResult(text, type = 'muted') {
        refs.resultPanel.classList.remove('success');
        if (type === 'success') {
          refs.resultPanel.classList.add('success');
        }

        refs.resultText.className = type === 'muted' ? 'muted' : type;
        refs.resultText.textContent = text;
      }

      function setSelected(strategy) {
        if (!state.quotes?.byStrategy?.[strategy]?.length) {
          return;
        }

        Object.values(strategyCards).forEach((node) => node.classList.remove('selected'));
        strategyCards[strategy].classList.add('selected');

        state.strategy = strategy;
        state.route = state.quotes.byStrategy[strategy][0];

        refs.youPay.textContent = format(state.route.sourceAmount);
        refs.networkFee.textContent = format(state.route.displayFeeUsd);
        refs.totalAmount.textContent = format(state.route.displayTotalUsd);
        refs.routeSummary.textContent = `${state.route.sourceSymbol} on ${state.route.sourceChain} · success ${state.route.displayConfidence}%`;
        refs.payBtn.textContent = `Pay ${format(state.route.displayTotalUsd)}`;
      }

      function renderRouteCards() {
        ['fastest', 'cheapest', 'balanced'].forEach((strategy) => {
          const route = state.quotes?.byStrategy?.[strategy]?.[0];
          if (!route) {
            strategyMeta[strategy].textContent = 'No route';
            return;
          }

          strategyMeta[strategy].textContent = `${route.sourceSymbol} on ${route.sourceChain}`;
        });
      }

      async function refresh() {
        refs.refreshBtn.disabled = true;
        refs.payBtn.disabled = true;
        refs.payBtn.textContent = `Pay ${format(checkout.fixedAmount)}`;
        refs.payBtn.onclick = runPayment;

        setProgress(18);
        setStatus('Finding routes');
        setResult('Refreshing available routes', 'muted');

        state.quotes = await smartPaySDK.quoteCheckout({ checkout, wallet, strategy: state.strategy, networks });
        renderRouteCards();

        if (!state.route) {
          setSelected('fastest');
        } else {
          setSelected(state.strategy);
        }

        setProgress(100);
        window.setTimeout(() => setProgress(0), 180);
        setStatus('Ready');
        setResult('Select a route and confirm payment.', 'muted');
        refs.refreshBtn.disabled = false;
        refs.payBtn.disabled = false;
      }

      async function runPayment() {
        if (!state.route) {
          setResult('No route selected', 'muted');
          return;
        }

        refs.payBtn.disabled = true;
        refs.refreshBtn.disabled = true;

        setProgress(24);
        setStatus('Connecting');
        await new Promise((resolve) => setTimeout(resolve, 280));

        setStatus('Confirming');
        setProgress(50);
        await new Promise((resolve) => setTimeout(resolve, 280));

        setStatus('Processing');
        setProgress(80);

        const result = await smartPaySDK.execute({
          route: state.route,
          wallet,
          forceExecution: false,
          delayMs: 900,
        });

        if (!result.ok) {
          setProgress(100);
          setStatus('Payment failed');
          setResult(result.failureReason || 'Execution failed', 'error');
          refs.payBtn.disabled = false;
          refs.refreshBtn.disabled = false;
          return;
        }

        setProgress(100);
        setStatus('Payment complete');
        const shortHash = `${result.txHash.slice(0, 8)}...${result.txHash.slice(-6)}`;
        setResult(`Payment successful • ${shortHash}`, 'success');

        refs.payBtn.textContent = 'Copy Tx Hash';
        refs.payBtn.onclick = async () => {
          try {
            await navigator.clipboard.writeText(result.txHash);
            setResult('Transaction hash copied', 'success');
          } catch {
            setResult('Clipboard blocked', 'error');
          }
        };

        refs.refreshBtn.disabled = false;
      }

      refs.copyWallet.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(wallet.address);
          setResult(`Copied ${shortAddress(wallet.address)}`, 'success');
        } catch {
          setResult('Copy blocked', 'error');
        }
      });

      Object.entries(strategyCards).forEach(([strategy, node]) => {
        node.addEventListener('click', () => setSelected(strategy));
      });

      refs.refreshBtn.addEventListener('click', refresh);
      refs.payBtn.addEventListener('click', runPayment);

      refs.walletAddress.textContent = shortAddress(wallet.address);
      refresh();
    </script>
  </body>
</html>
